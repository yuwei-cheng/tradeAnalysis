---
title: "OKEX Data Analysis"
author: "Yuwei Cheng"
date: "Created on 2021-05-24. Updated on `r Sys.Date()`."
output:
  html_document:
    css: C:/Users/yuwei/guyi Dropbox/Yuwei Cheng/TG RESEARCH's shared workspace/tradeAnalysis/code/style.css
    highlight: tango
    theme: paper
    toc: yes
    toc_float:
      collapsed: no
      smooth_scroll: no
    code_folding: show
    number_sections: yes
  pdf_document:
    toc: yes
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Load libraries
suppressMessages(library(stringr))
suppressMessages(library(dplyr))
suppressMessages(library(lubridate))
suppressMessages(library(ggplot2))
suppressMessages(library(tidyr))
suppressMessages(library(scales))
#library(forecast)
#library(tseries)
suppressMessages(library(zoo))
```

```{r}
# Split different types of contract
splitCon = function(x,name)
{
  x %>% subset(contract_type %in% c(name)) %>% 
    select(close, trade_time, symbol, vol, date)
}

makedf = function(x,y)
{
  common_time = intersect(x$trade_time, y$trade_time)
  x = x %>% subset(trade_time %in% common_time)
  y = y %>% subset(trade_time %in% common_time)
  
  df = merge(x,y,by = "trade_time") %>%
    mutate(diff = close.x - close.y) %>%
    mutate(return = (close.x - close.y)/close.y)
  
  df = df[!duplicated(df),]
  
  return(df)
}

returnDist = function(x, t1, t2)
{
  print(paste0("Premium distribution prior ", t1))
  print(signif(quantile(x$return[x$trade_time<t1], 
                        c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1)), 3))
  print(paste0("Premium distribution between ", t1, " and ", t2))
  print(signif(quantile(x$return[x$trade_time>t1 & x$trade_time<t2], 
                        c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1)), 3))
  print(paste0("Premium distribution after ", t2))
  print(signif(quantile(x$return[x$trade_time>t2], 
                        c(0, 0.025, 0.25, 0.5, 0.75, 0.975, 1)), 3))
}

returnPlot = function(x,t1,t2)
{
  par(mfrow = c(1,3), mar = c(3,3,1,1))
  hist(x$return[x$trade_time<t1], xlab = "", ylab = "return", main = NULL)
  hist(x$return[x$trade_time>t1 & x$trade_time<t2],
        xlab = "", ylab = "return",  main = NULL)
  hist(x$return[x$trade_time>t2],  xlab = "", ylab = "return",  main = NULL)
  par(mfrow = c(1,1))
}

```

```{r}
data = read.csv("C:/Users/yuwei/guyi Dropbox/Yuwei Cheng/TG RESEARCH's shared workspace/tradeAnalysis/data/BTC/btc_usdt_60min_all.csv")

# Exchange platform: OKEX
# TS_code: BTC_USDT
# Freq: on hour, 60 minutes
# Is_contract: Yes

data = data %>% 
  select(-X, - exchange, - ts_code, -freq, -is_contract) %>%
  mutate(trade_time = ymd_hm(trade_time))

data$contract_type = 
  do.call(rbind,
          str_split(data$symbol, "-", n = Inf, simplify = FALSE))[,3]

# Label contract type
data = data %>% 
  mutate(contract_type =  
           ifelse(contract_type != "SWAP",
                  contract_type, "180101")) %>% 
  mutate(type = ymd(contract_type)) %>%
  mutate(date = as.Date(trade_time)) %>%
  mutate(difference = type - date) %>%
  mutate(contract_type  = 
           ifelse(difference <0, "SWAP",
                  ifelse(difference >= 90, "4 Next Season",
                         ifelse(difference >=14, "3 Current Season",
                                ifelse(difference >= 7, "2 Next Week",
                                       "1 Current Week")))))%>%
  select(-difference, -date, -type)

data$date = as.Date(data$trade_time)
```

```{r}
current_week  = splitCon(data, "1 Current Week")
next_week = splitCon(data, "2 Next Week")
current_season = splitCon(data, "3 Current Season")
next_season = splitCon(data, "4 Next Season")
swap = splitCon(data, "SWAP")


df1 = makedf(current_week, swap)
df2 = makedf(next_week, swap)
df3 = makedf(current_season, swap)
df4 = makedf(next_season, swap)
```



# 当周合约和永续合约

## 溢价分析

$premium (\%) = \frac{P_{futures} - P_{swap}}{P_{swap}}$

2020年11月之前，溢价百分比的中位数在千一左右，Q3在千二左右，最高溢价百分比在千四。
2020年11月之后到2021年4月中之前，溢价百分比的中位数在千三左右，Q3在千四左右，最高溢价百分比百一。
2021年4月中之后，溢价百分比的中位数在千一左右，Q3在千三左右，最高溢价百分比千九。

正套的机会2021年4月中以后还是存在的，因为Q3的差别不是很大。

需要注意的是，反套的机会集中出现在2020年年末和2021年2月之间。当周的价格比永续的
价格最高低了三个百分点。这个机会出现在2021年2月23号下午两点。永续合约的交易量极低
只有1830。当然这个也有可能是错误数据。

反套溢价百分比小于前三的机会总共就只出现了12次


```{r}
# 溢价分布

returnDist(df1, df1$trade_time[820], df1$trade_time[4046])

df1 %>% ggplot() +
  geom_line(aes(x = trade_time, y = return)) + theme_bw() +
  geom_vline(xintercept = df1$trade_time[c(820, 4046)],
             linetype = "dotted",
             color = "red")+
  scale_x_datetime(breaks = date_breaks("2 month"),
                   minor_breaks = date_breaks("7 day"))+
  labs(x = NULL, title = "当周合约和永续合约的价差", y = "premium (%)")

# 反套小于百一

df1 %>% subset(return < -0.01) %>% 
  select(trade_time, close.x, vol.x, close.y, vol.y, diff, return) %>%
  rename("futures close price" = "close.x") %>%
  rename("swap close price" = "close.y") %>%
  rename("futures vol" = "vol.x") %>%
  rename("swap vol" = "vol.y")

# 反套小于千三

df1 %>% subset(return < -0.003) %>% 
  select(trade_time, close.x, vol.x, close.y, vol.y, diff, return) %>%
  rename("futures close price" = "close.x") %>%
  rename("swap close price" = "close.y") %>%
  rename("futures vol" = "vol.x") %>%
  rename("swap vol" = "vol.y")
```
## 成交量分析
我算了每天当周合约的总成交量。有意思的是，周五往往是每周成交量最少的一天。

```{r}
current_week %>%
  group_by(date) %>%
  summarize(sum = sum(vol)) %>% 
  ggplot() + geom_line(aes(x = date, y = sum)) + theme_bw() +
  # scale_y_continuous(limits = c(5,8))+
  scale_y_log10(
    breaks = trans_breaks("log10", function(x) 10^x),
    labels = trans_format("log10", math_format(10^.x)),
    limits = c(10^3, 10^8)
  ) +
  geom_vline(xintercept = current_week$date[weekdays(current_week$date) == "星期五"],
             color = "red", linetype = "dotted") +
  # geom_vline(xintercept = vol$date[weekdays(vol$date) == "星期三"],
  #            color = "blue", linetype = "dotted") +
  geom_vline(xintercept = current_week$date[weekdays(current_week$date) == "星期一"],
             color = "green", linetype = "dotted") +
  scale_x_date(date_breaks = "1 month", date_label = "%b-%d") +
  labs(x = NULL, y = "date volume")
```


## 次周合约和永续合约的溢价分析

2020年11月之前，溢价百分比的中位数在千二左右，Q3在千三左右，最高溢价百分比在千六。
2020年11月之后到2021年4月中之前，溢价百分比的中位数在千七左右，Q3在百一左右，最高溢价百分比百三。
2021年4月中之后，溢价百分比的中位数在千四左右，Q3在千六左右，最高溢价百分比百一点五。

正套的机会2021年4月中以后还是存在的，因为Q3的差别不是很大。

```{r}
returnDist(df2, df1$trade_time[820], df1$trade_time[4046])

df2 %>% ggplot() +
  geom_line(aes(x = trade_time, y = return)) + theme_bw() +
  geom_vline(xintercept = df1$trade_time[c(820,4046)],
             linetype = "dotted",
             color = "red")+
  scale_x_datetime(breaks = date_breaks("2 month"),
                   minor_breaks = date_breaks("14 day"))+
  labs(x = NULL, title = "次周合约和永续合约", y = "premium (%)")

df2 %>% subset(return < -0.01) %>% 
  select(trade_time, close.x, vol.x, close.y, vol.y, diff, return) %>%
  rename("futures close price" = "close.x") %>%
  rename("swap close price" = "close.y") %>%
  rename("futures vol" = "vol.x") %>%
  rename("swap vol" = "vol.y")
```


```{r}
returnDist(df3, df1$trade_time[820], df1$trade_time[4046])

df3 %>% ggplot() +
  geom_line(aes(x = trade_time, y = return)) + theme_bw() +
  geom_vline(xintercept = df1$trade_time[c(820,4046)],
             linetype = "dotted",
             color = "red")+
  scale_x_datetime(breaks = date_breaks("2 month"),
                   minor_breaks = date_breaks("1 month")) +
  labs(x = NULL, title = "当季合约和永续合约", y = "premium (%)")

df3 %>% subset(return < -0.01) %>% 
  select(trade_time, close.x, vol.x, close.y, vol.y, diff, return) %>%
  rename("futures close price" = "close.x") %>%
  rename("swap close price" = "close.y") %>%
  rename("futures vol" = "vol.x") %>%
  rename("swap vol" = "vol.y")
```



```{r}
df4 %>% ggplot() +
  geom_line(aes(x = trade_time, y = return)) + theme_bw() +
  geom_vline(xintercept = df1$trade_time[c(820, 4046)],
             linetype = "dotted",
             color = "red")+
  scale_x_datetime(breaks = date_breaks("2 month"),
                   minor_breaks = date_breaks("1 month")) +
  labs(x = NULL, title = "次季合约和永续合约")
```


```{r}
returnDist(df4, df1$trade_time[820], df1$trade_time[4046])
returnPlot(df4, df1$trade_time[820], df1$trade_time[4046])
```

```{r}
# data = read.csv("C:/Users/yuwei/TG RESEARCH Dropbox/历史数据/priceAnalysis/data/BTC/btc_usdt_60min_all.csv")
# data = data %>% select(-X, - exchange, - ts_code, -freq, -is_contract) %>%
#   mutate(trade_time = ymd_hms(trade_time))

# data$contract_type = do.call(rbind,
#         str_split(data$symbol, "-", n = Inf, simplify = FALSE))[,3]
# 
# # Classify contract type
# data =
# data %>% mutate(contract_type =  ifelse(contract_type != "SWAP",
#                                         contract_type, "180101")) %>%
#   mutate(type = ymd(contract_type)) %>%
#   mutate(date = as.Date(trade_time)) %>%
#   mutate(difference = type - date) %>%
#   mutate(contract_type  =
#            ifelse(difference <0, "SWAP",
#                   ifelse(difference >= 90, "4 Next Season",
#                          ifelse(difference >=14, "3 Current Season",
#                                 ifelse(difference >= 7, "2 Next Week",
#                                        "1 Current Week")))))%>%
#   select(-difference, -date, -type)

# Price
data %>%
  ggplot() +
  geom_line(aes(x = trade_time, y=close, colour = contract_type)) +
  theme_bw() + labs(x = "Trade Time", y = "BTC Close Price",
                    colour = "Type")+
  scale_x_datetime(date_labels = "%b-%d", breaks = "2 month") +
  scale_y_continuous(breaks = seq(10000, 80000, 10000)) +
  # scale_color_viridis(discrete = TRUE, option = "D")
  scale_color_manual(values=c("#999999", "#E69F00",
                              "#56B4E9", "#d62828", "#003566"))
# Volume
data %>%
  ggplot() + facet_wrap(~ contract_type) +
  geom_line(aes(x = trade_time, y = log(vol)),color = "steelblue") +
  theme_bw() + labs(x = "Trade Time", y = "BTC vol in log scale",
                    colour = "Type")+
  scale_x_datetime(date_labels = "%b-%d", breaks = "2 month")

```

```{r}
# Identify days which has extremely low volume
data %>% subset(contract_type == "SWAP") %>%
  subset(vol == min(vol))

data %>% subset(contract_type == "1 Current Week") %>%
  subset(vol == min(vol))

data %>% subset(contract_type == "2 Next Week") %>%
  subset(vol == min(vol))

data %>% subset(contract_type == "3 Current Season") %>%
  subset(vol == min(vol))

data %>% subset(contract_type == "4 Next Season") %>%
  subset(vol == min(vol))
```

